FROM ruby:3.3.6

ENV LANG C.UTF-8
ENV TZ=Asia/Tokyo
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update -qq \
  && apt-get install -y --no-install-recommends \
     ca-certificates curl gnupg build-essential libpq-dev wget git vim \
     lsb-release gnupg2 \
  && mkdir -p /etc/apt/keyrings \
  && rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
  && apt-get update -qq \
  && apt-get install -y --no-install-recommends nodejs \
  && rm -rf /var/lib/apt/lists/*

RUN corepack enable \
  && corepack prepare yarn@1.22.22 --activate || \
     (npm install -g yarn@1.22.22 && true)

WORKDIR /myapp

# Bundler を最新化
RUN gem install bundler --no-document

# ---- Node / Yarn 関連：先に package.json をコピーしてインストール（キャッシュ有効化）
COPY package.json yarn.lock ./

# node_modules/.bin を PATH に加えておく（Procfile で直接 'esbuild' を呼んでいる場合に必要）
ENV PATH=/myapp/node_modules/.bin:$PATH

# yarn install（ロックファイルがある想定）
RUN yarn install --frozen-lockfile --network-timeout 600000 || yarn install

# ---- Ruby gems：先に Gemfile をコピーして bundle install（キャッシュ効く）
COPY Gemfile Gemfile.lock ./

ENV BUNDLE_JOBS=4 \
    BUNDLE_PATH=/gems \
    BUNDLE_APP_CONFIG=/gems/.bundle

RUN bundle config set without 'production' \
  && bundle install --jobs 4 --retry 3

# アプリソースを最後にコピー
COPY . /myapp

# 任意：デフォルトコマンド（必要なら有効化）
# CMD ["bin/dev"]